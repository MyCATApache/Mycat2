<?xml version="1.0" encoding="UTF-8"?>
<project xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://maven.apache.org/POM/4.0.0"
  xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
  <parent>
    <artifactId>parent</artifactId>
    <groupId>io.mycat</groupId>
    <version>0.3-SNAPSHOP</version>
  </parent>
  <modelVersion>4.0.0</modelVersion>
  <packaging>jar</packaging>
  <artifactId>mycat2</artifactId>

  <dependencies>
    <dependency>
      <groupId>io.mycat</groupId>
      <artifactId>proxy</artifactId>
      <version>0.3-SNAPSHOP</version>
    </dependency>
    <dependency>
      <groupId>io.mycat</groupId>
      <artifactId>common</artifactId>
      <version>0.3-SNAPSHOP</version>
    </dependency>
    <dependency>
      <groupId>io.mycat</groupId>
      <artifactId>grid</artifactId>
      <version>0.3-SNAPSHOP</version>
    </dependency>
    <!-- https://mvnrepository.com/artifact/mysql/mysql-connector-java -->
    <dependency>
      <groupId>mysql</groupId>
      <artifactId>mysql-connector-java</artifactId>
      <version>8.0.17</version>
    </dependency>
    <dependency>
      <groupId>io.mycat</groupId>
      <artifactId>pattern</artifactId>
      <version>0.3-SNAPSHOP</version>
    </dependency>
    <dependency>
      <groupId>org.eclipse.collections</groupId>
      <artifactId>eclipse-collections-api</artifactId>
      <version>10.0.0</version>
    </dependency>
    <dependency>
      <groupId>org.eclipse.collections</groupId>
      <artifactId>eclipse-collections</artifactId>
      <version>10.0.0</version>
    </dependency>
    <dependency>
      <groupId>it.unimi.dsi</groupId>
      <artifactId>fastutil</artifactId>
      <version>8.3.0</version>
    </dependency>
    <!-- https://mvnrepository.com/artifact/au.com.bytecode/opencsv -->
    <dependency>
      <groupId>au.com.bytecode</groupId>
      <artifactId>opencsv</artifactId>
      <version>2.4</version>
    </dependency>
    <!-- https://mvnrepository.com/artifact/com.google.guava/guava -->
    <dependency>
      <groupId>com.google.guava</groupId>
      <artifactId>guava</artifactId>
      <version>28.1-jre</version>
    </dependency>
    <!-- https://mvnrepository.com/artifact/org.apache.crail/crail-parent -->
    <dependency>
      <groupId>org.apache.crail</groupId>
      <artifactId>crail-parent</artifactId>
      <version>1.1-incubating</version>
      <type>pom</type>
    </dependency>
    <!-- https://mvnrepository.com/artifact/org.apache.crail/crail-storage -->
    <dependency>
      <groupId>org.apache.crail</groupId>
      <artifactId>crail-storage</artifactId>
      <version>1.1-incubating</version>
    </dependency>

  </dependencies>
  <build>
    <plugins>
      <plugin>
        <artifactId>maven-assembly-plugin</artifactId>
        <version>3.1.1</version>
        <configuration>
          <finalName>mycat2-${project.version}-${timestamp}-single</finalName>
          <appendAssemblyId>false</appendAssemblyId>
          <descriptorRefs>
            <descriptorRef>jar-with-dependencies</descriptorRef>
          </descriptorRefs>
          <archive>
            <manifest>
              <mainClass>io.mycat.MycatCore</mainClass>
            </manifest>
          </archive>
        </configuration>
        <executions>
          <execution>
            <id>make-assembly</id> <!-- this is used for inheritance merges -->
            <phase>package</phase> <!-- 指定在打包节点执行jar包合并操作 -->
            <goals>
              <goal>single</goal>
            </goals>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>appassembler-maven-plugin</artifactId>
        <version>2.1.0</version>
        <configuration>
          <configurationDirectory>conf</configurationDirectory>
          <!--配置文件拷贝-->
          <configurationSourceDirectory>src/main/resources</configurationSourceDirectory>
          <copyConfigurationDirectory>true</copyConfigurationDirectory>
          <!--配置文件拷贝-->
          <repositoryLayout>flat</repositoryLayout>
          <repositoryName>lib</repositoryName>
          <includeConfigurationDirectoryInClasspath>true</includeConfigurationDirectoryInClasspath>
          <target>${project.build.directory}</target>
          <useWildcardClassPath>true</useWildcardClassPath>
          <encoding>UTF-8</encoding>
          <tempDirectory>tmp</tempDirectory>
          <daemons>
            <daemon>
              <id>mycat</id>
              <mainClass>io.mycat.MycatCore</mainClass>
              <commandLineArguments>
                <commandLineArgument>start</commandLineArgument>
              </commandLineArguments>
              <platforms>
                <platform>jsw</platform>
              </platforms>
              <generatorConfigurations>
                <generatorConfiguration>
                  <generator>jsw</generator>
                  <includes>
                    <!--<include>linux-x86-32</include>-->
                    <include>linux-x86-64</include>
                    <!--<include>windows-x86-32</include>-->
                    <include>windows-x86-64</include>
                  </includes>
                  <configuration>
                    <property>
                      <name>wrapper.logfile</name>
                      <valueStartIndex>logs/wrapper.log</valueStartIndex>
                    </property>
                  </configuration>
                </generatorConfiguration>
              </generatorConfigurations>
              <jvmSettings>
                <initialMemorySize>256M</initialMemorySize>
                <maxMemorySize>512M</maxMemorySize>
                <systemProperties>
                  <systemProperty>MYCAT_HOME=./conf</systemProperty>
                </systemProperties>
                <extraArguments>
                  <extraArgument>-server</extraArgument>
                  <!-- 远程JMX -->
                  <extraArgument>-Dcom.sun.management.jmxremote</extraArgument>
                  <extraArgument>-Dcom.sun.management.jmxremote.port=1984</extraArgument>
                  <extraArgument>-Dcom.sun.management.jmxremote.authenticate=false</extraArgument>
                  <extraArgument>-Dcom.sun.management.jmxremote.ssl=false</extraArgument>
                  <extraArgument>-Xmx4G</extraArgument>
                  <extraArgument>-Xms1G</extraArgument>
                </extraArguments>
              </jvmSettings>
            </daemon>
          </daemons>
        </configuration>
        <executions>
          <execution>
            <id>generate-jsw-scripts</id>
            <phase>package</phase>
            <goals>
              <goal>generate-daemons</goal>
            </goals>
          </execution>
        </executions>
      </plugin>

      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-antrun-plugin</artifactId>
        <version>1.8</version>
        <executions>
          <execution>
            <id>createDistJar</id>
            <goals>
              <goal>run</goal>
            </goals>
            <phase>package</phase>
            <configuration>
              <target>
                <echo message="${project.build.directory}"/>
                <mkdir dir="${project.build.directory}"/>
                <mkdir dir="${project.build.directory}/jsw/mycat/logs"/>
                <tar basedir="${project.build.directory}/jsw"
                  destfile="${project.build.directory}/mycat2-${project.version}-${timestamp}.tar.gz"
                  includes="mycat/bin/**,mycat/conf/**,mycat/logs,mycat/lib/mycat2**,mycat/lib/wrapper**">
                </tar>
                <tar basedir="${project.basedir}/src/main/resources"
                  destfile="${project.build.directory}/mycat2-${project.version}-${timestamp}-resources.tar.gz"
                  includes="**">
                </tar>
              </target>
            </configuration>
          </execution>
        </executions>
      </plugin>
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>buildnumber-maven-plugin</artifactId>
        <version>1.4</version>
        <executions>
          <execution>
            <phase>validate</phase>
            <goals>
              <goal>create</goal>
            </goals>
          </execution>
        </executions>
        <configuration>
          <format>{1}</format>
          <items>
            <item>timestamp</item>
          </items>
          <doCheck>false</doCheck>
          <doUpdate>false</doUpdate>
          <timestampFormat>{0,date,yyyyMMddHHmmss}</timestampFormat>
        </configuration>
      </plugin>
    </plugins>
  </build>
</project>